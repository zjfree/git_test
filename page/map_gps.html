<!-- 地图当前GPS路径 zjfree 2019-12-03 -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>地图当前GPS路径</title>

<link href="https://lib.baomitu.com/normalize/latest/normalize.min.css" rel="stylesheet">
<link href="../static/map/css/leaflet.css" id="theme" rel="stylesheet">

<style>
/* css style */
body, html{
	width:100%;
	height:100%;
	overflow: hidden;
}

#divMap{
	position: absolute;
	top:0;
	left:0;
	right:0;
	bottom:30px;
	background: #eff;
}

#divInfo{
	position: absolute;
	bottom:0px;
	z-index: 1000;
	width:100%;
	height:30px;
	font-size:12px;
	color:#000;
	line-height:15px;
}
#divBtn{
	position: absolute;
	bottom:40px;
	right:10px;
	z-index: 1000;
}
</style>

<script src="https://lib.baomitu.com/jquery/3.4.1/jquery.min.js"></script>
<script src="../static/map/js/leaflet.js"></script>
<script src="../static/map/js/leaflet.ChineseTmsProviders.js"></script>
<script src="../static/map/js/leaflet_map.js"></script>
<script src="../static/map/js/GpsConvert.js"></script>

</head>
<body>
<!-- 内容 -->
<div id="divMap"></div>
<div id="divInfo"></div>
<div id="divBtn">
<button onclick="watchGps();">重启GPS</button> &nbsp;
<button onclick="clearPath();">清空</button> &nbsp;
<button onclick="upload();">上传</button>
</div>

<script>
var mapLayerList = SuperMap.getLayerList();
var map;
var index = 0;

var myMarker = null;
var polyline = null;
var gpsList = [];
var lastGps = null;
var distTotal = 0;

window.onerror = function(message, source, lineno, colno, error) {
	$('#divInfo').css('color', 'red').html('error:[' + lineno + '] ' + message);
}

function clearPath()
{
	gpsList = [];
	distTotal = 0;
	if (polyline != null)
	{
		polyline.setLatLngs([]);
	}
}

function upload()
{
	alert(gpsList.length);
}

function fnum(num, dec)
{
	if (typeof num == 'undefined' || isNaN(num))
	{
		return '?';
	}
	
	return parseFloat(num).toFixed(dec);
}

var watchId = null;
function watchGps()
{
	if (watchId != null)
	{
		navigator.geolocation.clearWatch(watchId);
	}
	
	// latitude longitude 
	watchId = navigator.geolocation.watchPosition(function(e){
		e.coords.timestamp = e.timestamp;
		watchGpsSuccess(e.coords);
	}, function(e) {
		$('#divInfo').css('color', 'red').html('error:' + e.message);
    }, {
		enableHighAccuracy: true,
		timeout: 5000,
		maximumAge: 0
	});
}

function watchGpsSuccess(e)
{
	index++;
	let gps = GpsConvert.wgs84_gcj([e.latitude, e.longitude]);
	
	if (myMarker == null)
	{
		myMarker = L.circleMarker(gps, {radius:5, weight:1, color:'#fff', fillColor:'#4AFF59', fillOpacity:0.9}).addTo(map);	
	}
	else
	{
		myMarker.setLatLng(gps);
	}
	
	if (polyline == null)
	{
		polyline = L.polyline([], {color: '#FF504B', weight:1}).addTo(map);
	}
	
	polyline.addLatLng(gps);
	
	map.stop().panTo(gps);
	gpsList.push(gps);
	
	let dist = lastGps == null ? 0 : map.distance(gps, lastGps);
	lastGps = gps;
	distTotal += dist;
	
	let str = '(' + index + ') ' + fnum(gps[0], 8) + ',' + fnum(gps[1], 8) + ' L:' + fnum(dist, 2) + 'm ' + fnum(distTotal, 0) + 'm<br>';
	str += 'R:' + fnum(e.accuracy, 0) + 'm, H:' + fnum(e.altitude, 2) + 'm, ' + fnum(e.heading, 0) + '°, ' + fnum(e.speed, 3) + 'm/s ';
	str += new Date(e.timestamp).toLocaleString();
	
	$('#divInfo').css('color', '#000').html(str);
}

$(function(){
	// JS
	let centerGps = [34, 109];
    map = L.map("divMap", {
        center: centerGps,
        zoom: 17,
        layers: mapLayerList['google_Hybrid'],
        zoomControl: true,
        detectRetina: true,
    });

    L.control.scale({imperial:false}).addTo(map);
	L.control.layers(mapLayerList, null).addTo(map);
	
    // Geolocation
	/*
    map.locate({
		setView: false,
		maxZoom: 18,
		watch: true,
		enableHighAccuracy: true,
    });

    map.on('locationfound', function(e) {
		e.latitude = e.latlng.lat;
		e.longitude = e.latlng.lng;
		watchGpsSuccess(e);
    });

    map.on('locationerror', function(e) {
		$('#divInfo').css('color', 'red').html('error:' + e.message);
    });
	*/
	
	watchGps();

    SuperMap.hideCompany();
});
</script>

<!-- 51啦访问统计 -->
<script type="text/javascript" src="//js.users.51.la/20254973.js"></script>

</body>